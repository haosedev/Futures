#测试workerman开发
安装方式
composer install
composer require workerman/mysql




#1.数据传输模型
以单品数据进行传输包含：  
编号，名称，昨日价，开盘价，当前价，涨幅（与今日起始价进行对比），涨跌，当日最高，当日最低

**从长远看，每只股票应该都有一个表来存所有的成交数据。


#2.定时进行开盘收盘操作
每日几点开盘，读取昨日收盘价格信息，决定今日开盘信息。	OK  
启动Event自动对盘面进行概率波动调整，并发送给客户。		OK  
每日几点收盘，停止Event，并对盘面数据进行结算，并保存到数据库。  OK
当日最高涨停跌停判断  OK
大盘数据管理Class化  OK  


附带计算大盘统计（收盘时保存）  OK    
重新调整OFFER的KEY和方式（是否附带大盘变化走势），如果附带，那新连接用户会出现第一次获取数据会多 （N-1条大盘无效数据）。如果不附带，那全体用户每次会多收一条大盘数据。  OK  


#3.账号功能
账号登录，沿用账号管理体系  
账号内需要有余额，登录时间等信息  
账号需要另外一张表记录仓位信息  
持仓表：用户id，代码，买入均价，持股数量，最后买入日期，最后买入数量  
**用户维持登陆问题，用户一旦刷新连接会会丢失登陆状态，是否可以在客户端存入一串Token包含特殊时段内用户登陆状况。重连后客户端内存中还有Token，直接提交Token去服务器验证获取数据。


#4.交易促成  
*GameServer这个类为主服务器类的话，分布式如何处理。（把通讯服务器与主数据服务器分离、然后再建立交易服务器吗？）  
*关于交易功能建立  
*关于账号功能建立（用户数据）  
挂单功能
所有挂单必须存入数据库，每次撮合计算涉及到大量的数据库查询修改操作。
每次发起订单后，由买和卖分别开启一次搜寻对立表寻找匹配的操作，直到无匹配时，写入本表等待其他订单收到时再触发。
关于买入生成挂单，考虑账户余额是否足够购买，挂单后账户余额实际扣除，生成购买挂单。每当碰到close触发，自动结算已完成的数据，重新计算keepstock均价，未完成的挂单数据退回未使用余额。
卖出后成本计算公式 总买成本/剩余单位数量。  每次卖出后，把总买入成本-卖出的金额重新计算回买入成本。
关于卖出生成挂单，考虑持仓是否足够卖出，挂单后实际减少持仓数量，生成挂单。每当碰到clse触发自动结算，自动结算已完成的数据，重新计算keepstock均价，未完成的挂单数据退回未使用的持仓。
买入后成本计算公式 总买成本/剩余单位数量。  每次买入后，把总买入成本+当前买入花费，重新计算买入成本。
要防止自己卖出的被自己买入（在操作询单时应该避开自己）
应该还要一个成交表，一个订单可能存在与多个订单的间接成交，但是每笔成交的记录都应该保存。
增加印花税设置，单向，税收表(对应流水单号)
佣金：佣金买卖双向收取，不超过成交金额的千分之3，单笔最少不低于5元，由证券公司收取
过户费：过户费买卖双方收取，收成交金额的千分之0.2，由证券交易所收取
单向收取可以在成交时对卖方的收益进行扣除，但是双向收取，必须在买方挂单时，计算其股票实际购入金额后加入 各种税费到实际金额内用于锁定。
股票买入有冻结，卖出也需要通过冻结来处理。
买股票时，金额是否使用冻结方式，等成交时改动金额，退单时直接解锁冻结金额。
买卖成交后，股票的交割，用户余额的变化
取消挂单、自动清单，并退回剩余的未成交金额以及票数。
**自发取消订单功能
改动较大，需要重新测试买卖挂单
**其实交易发单以单线程形式运行效果更安全可靠。每次挂单（多线程），都进入总挂单表Redis，系统以某条现成内单线程方式逐条读取并处理。
实现前端数据对接
制作挂单信息接收和更新（接收到挂单信息，对已有的信息进行更新，对没有的信息进行增添）
提交挂单信息
向系统挂消息，刷新买方卖方的数据。
解决问题：先挂买入，再挂卖出。成交后，被动成交方的刷新因数据库原因，需做延迟操作。
解决问题：挂卖单，到最后自动撤销时，未清理卖出锁定
修复价格框无法输入 4.1，直接跳成4.09
修复StockData的 TimeControl 并为管理到启动时的非开盘时段的自动开盘

SendMyOrder  发送给用户挂单信息

  id	daytime 开盘序列  create_time 挂单时间	update_time 更新时间	sn 订单序列号	code 股票代码	price 交易定价（购入定价）	surplus 剩余购入数量	amount 计划购入数量	money 计划花费金额	uid 会员代码	status 0未完成，1已完成

*走势设置，开盘设置走势，趋向于涨跌范围概率。


*交易功能  
为了不是在买入后等待涨停跌停再出手（这样游戏就毫无意义），需要指定规则强制换手。类似于期货的交割日，到期自动平仓。（收盘时间自动平仓，这样就会带来更多的可玩性） 
交易手续费



#5. 打造控制后台，用于新增调整股票，用户数据等。  
**后台用户账号管理，可新增账号，编辑账号
**后台股票管理，发行新股，股票更名（不更改代码），更改价格功能，查询股票信息等